--CREATE DATABASE DRAFT1;
--GO

USE DRAFT1;
GO

CREATE TABLE [USER] (
	ID	CHAR(9), --NO. OF DIGITS IN ID
	PRIMARY KEY (ID)
);

CREATE TABLE [ADMIN] (
	AdminID	CHAR(9) PRIMARY KEY,
	[ROLE]	VARCHAR(20) NOT NULL,
	FOREIGN KEY (AdminID) REFERENCES [USER] (ID) ON DELETE CASCADE
);

CREATE TABLE [Order]
(
    ID VARCHAR(20) PRIMARY KEY,
    Total INTEGER,
    Order_Time DATETIME2
)
GO

CREATE TABLE PROMOTION (
	ID	CHAR(9), --NO. OF DIGITS IN PROMOTION
	[TYPE] VARCHAR(10) CHECK ([TYPE] IN ('GIFT', 'DISCOUNT')),
	START_DATE DATE NOT NULL,
	END_DATE DATE NOT NULL,
	AdminID	CHAR(9),
	PRIMARY KEY (ID),
	FOREIGN KEY (AdminID) REFERENCES [ADMIN] (AdminID) ON DELETE SET NULL
);

CREATE TABLE GIFT (
	PromotionID CHAR(9),
	PRICE INT NOT NULL,
	QUANTITY INT NOT NULL,
	PRIMARY KEY (PromotionID),
	FOREIGN KEY (PromotionID) REFERENCES PROMOTION(ID) ON DELETE CASCADE
);

CREATE TABLE DISCOUNT (mj
	PromotionID CHAR(9),
	[PERCENTAGE] DECIMAL(5,4),
	AMOUNT INT,
	PRIMARY KEY (PromotionID),
	FOREIGN KEY (PromotionID) REFERENCES PROMOTION(ID) ON DELETE CASCADE,
	CHECK ([PERCENTAGE] IS NOT NULL OR AMOUNT IS NOT NULL)
);

CREATE TABLE VEHICLE (
    VEHICLEID CHAR(10) PRIMARY KEY
);

CREATE TABLE TRAIN (
    VEHICLEID CHAR(10) PRIMARY KEY,
    SERIALNUMBER VARCHAR(50),
    WAGONNO INT,
    FOREIGN KEY (VEHICLEID) REFERENCES VEHICLE(VEHICLEID) ON DELETE CASCADE
);

CREATE TABLE PLANE (
    VEHICLEID CHAR(10) PRIMARY KEY,
    SERIALNUMBER VARCHAR(50),
    FOREIGN KEY (VEHICLEID) REFERENCES VEHICLE(VEHICLEID) ON DELETE CASCADE
);

CREATE TABLE MOTORBIKE (
    VEHICLEID CHAR(10) PRIMARY KEY,
    LICENSEPLATE VARCHAR(20),
    FOREIGN KEY (VEHICLEID) REFERENCES VEHICLE(VEHICLEID) ON DELETE CASCADE
);

CREATE TABLE OrderPromotion (
    OrderID VARCHAR(20) NOT NULL,
    PromotionID CHAR(9) NOT NULL,
    PRIMARY KEY (OrderID, PromotionID),
    FOREIGN KEY (OrderID) REFERENCES [Order](ID) ON DELETE CASCADE,
    FOREIGN KEY (PromotionID) REFERENCES PROMOTION(ID) ON DELETE CASCADE
);
GO

INSERT INTO [USER] (ID) VALUES
('000000001'),
('000000002'),
('000000003'),
('000000004'),
('000000005');
GO

INSERT INTO ADMIN (AdminID, ROLE) VALUES
('000000001', 'MANAGER'),
('000000002', 'MANAGER'),
('000000003', 'CEO'),
('000000004', 'LEADER'),
('000000005', 'MARKETER');
GO

INSERT INTO [Order] (ID, Total, Order_Time) VALUES
('ORD101', 300000, '2025-01-05 09:30:00'),
('ORD102', 450000, '2025-02-15 10:00:00'),
('ORD103', 900000, '2025-03-12 14:30:00'),
('ORD104', 1200000, '2025-03-05 16:00:00'),
('ORD105', 700000, '2025-04-15 10:30:00'),
('ORD106', 250000, '2025-05-25 08:45:00'),
('ORD107', 800000, '2025-06-20 13:15:00'),
('ORD108', 1000000, '2025-07-20 12:00:00'),
('ORD109', 950000, '2025-08-10 11:00:00');
GO

INSERT INTO PROMOTION (ID, [TYPE], START_DATE, END_DATE, AdminID) VALUES
('P00000001', 'GIFT', '2025-01-01', '2025-01-15', '000000001'),
('P00000002', 'DISCOUNT', '2025-02-01', '2025-02-28', '000000002'),
('P00000003', 'GIFT', '2025-03-10', '2025-03-25', '000000001'),
('P00000004', 'DISCOUNT', '2025-04-01', '2025-04-30', '000000002'),
('P00000005', 'GIFT', '2025-03-01', '2025-03-15', '000000002'),
('P00000006', 'GIFT', '2025-04-10', '2025-04-25', '000000004'),
('P00000007', 'DISCOUNT', '2025-05-20', '2025-06-05', '000000001'),
('P00000008', 'GIFT', '2025-06-15', '2025-06-30', '000000005'),
('P00000009', 'DISCOUNT', '2025-07-10', '2025-07-25', '000000004'),
('P00000010', 'DISCOUNT', '2025-08-05', '2025-08-20', '000000003');
GO

INSERT INTO GIFT (PromotionID, PRICE, QUANTITY) VALUES
('P00000001', 15000, 2),
('P00000003', 30000, 1),
('P00000005', 20000, 2),
('P00000006', 50000, 1),
('P00000008', 100000, 1);
GO

INSERT INTO DISCOUNT (PromotionID, [PERCENTAGE], AMOUNT) VALUES
('P00000002', 0.1000, NULL),  -- 10\% off
('P00000004', 0.1500, NULL),  -- 15\% off
('P00000007', 0.5000, NULL),  -- 50\% off
('P00000009', NULL, 99000),  -- 99,000VND off
('P00000010', NULL, 50000);   -- 50,000VND off
GO

INSERT INTO OrderPromotion (OrderID, PromotionID) VALUES
('ORD101', 'P00000001'),
('ORD102', 'P00000002'),
('ORD103', 'P00000003'),
('ORD104', 'P00000005'),
('ORD105', 'P00000004'),
('ORD105', 'P00000006'), -- same order two promos
('ORD106', 'P00000007'),
('ORD107', 'P00000008'),
('ORD108', 'P00000009'),
('ORD109', 'P00000010');
GO

INSERT INTO VEHICLE (VEHICLEID) VALUES
('V000000001'),
('V000000002'),
('V000000003'),
('V000000004'),
('V000000005'),
('V000000006'),
('V000000007'),
('V000000008'),
('V000000009'),
('V000000010'),
('V000000011'),
('V000000012'),
('V000000013'),
('V000000014'),
('V000000015');
GO

INSERT INTO TRAIN (VEHICLEID, SERIALNUMBER, WAGONNO) VALUES
('V000000001', 'SE1-2024', 15),
('V000000002', 'TN2-2023', 10),
('V000000003', 'HN-SG-05', 12),
('V000000004', 'DN-HUE-11', 8),
('V000000005', 'SPT2-2025', 9);
GO

INSERT INTO PLANE (VEHICLEID, SERIALNUMBER) VALUES
('V000000006', 'VN-A321'),
('V000000007', 'VN-A858'),
('V000000008', 'VJ-BA12'),
('V000000009', 'QH-2219'),
('V000000010', 'VN-B789');
GO

INSERT INTO MOTORBIKE (VEHICLEID, LICENSEPLATE) VALUES
('V000000011', '59X3-456.78'),
('V000000012', '30H2-123.45'),
('V000000013', '92B1-678.99'),
('V000000014', '47E1-888.88'),
('V000000015', '51F5-222.33');
GO


-- Select promotions within a date range
CREATE OR ALTER PROCEDURE sp_GetPromotionSummary
    @StartDate DATE = NULL,
    @EndDate DATE = NULL
AS
BEGIN
    ;WITH PromotionOrders AS (
        SELECT 
            op.PromotionID,
            COUNT(o.ID) AS NumOrders,
            SUM(o.Total) AS TotalOrderValue
        FROM OrderPromotion op
        INNER JOIN [Order] o ON o.ID = op.OrderID
        GROUP BY op.PromotionID
    )
    SELECT 
        p.[TYPE],
        COUNT(DISTINCT p.ID) AS TotalPromotions,

        -- Gift promotions: total gifts Ã— orders
        SUM(
            ISNULL(g.PRICE * po.NumOrders, 0)
        ) AS TotalGiftValue,
        
        SUM(
           ISNULL(d.AMOUNT * po.NumOrders, 0)
            + ISNULL(po.TotalOrderValue * d.[PERCENTAGE], 0)
        ) AS TotalDiscountValue,

        COUNT(DISTINCT p.AdminID) AS TotalAdmins
    FROM PROMOTION p
    LEFT JOIN PromotionOrders po ON po.PromotionID = p.ID
    LEFT JOIN GIFT g ON p.ID = g.PromotionID
    LEFT JOIN DISCOUNT d ON p.ID = d.PromotionID
    WHERE 
        (@StartDate IS NULL OR p.START_DATE >= @StartDate)
        AND (@EndDate IS NULL OR p.END_DATE <= @EndDate)
    GROUP BY 
        p.[TYPE]
    HAVING 
        COUNT(p.ID) > 0
    ORDER BY 
        TotalPromotions DESC;
END;


EXEC sp_GetPromotionSummary;
GO
